# 社群版程式碼審查插件

社群版本的 Git 提交程式碼審查工具，使用多個專門代理進行自動化審查，配備驗證機制以過濾誤報。

## 概述

社群版程式碼審查插件透過並行啟動多個代理從不同角度獨立審計 Git 提交的變更來自動化程式碼審查。與官方版本不同，此版本直接使用 Git 命令而非 GitHub CLI，適用於任何 Git 儲存庫，不需要 GitHub 整合。

### 與官方 code-review 的差異

| 功能 | 官方版本 | 社群版本 |
|------|----------|----------|
| 審查目標 | Pull Request | Git 提交 |
| 互動方式 | GitHub CLI (gh) | Git 命令 |
| 輸出方式 | GitHub PR 評論 | 終端機報告 |
| 依賴需求 | GitHub CLI + 認證 | 僅需 Git |
| 適用場景 | GitHub 專案 | 任何 Git 儲存庫 |

## 命令

### `/code-review`

對一個或多個 Git 提交執行自動化程式碼審查。

**支援的輸入格式：**
- 單一提交：`abc1234` 或 `HEAD`
- 提交範圍：`main..feature-branch` 或 `HEAD~5..HEAD`
- 多個提交：`abc1234 def5678`

**功能：**
1. 驗證提交是否存在且範圍合理（不超過 20 個提交）
2. 從儲存庫中收集相關的 CLAUDE.md 指南文件
3. 總結提交的變更內容
4. 啟動 4 個並行代理進行獨立審查：
   - **代理 #1 和 #2**：審計 CLAUDE.md 合規性
   - **代理 #3**：掃描差異中的明顯錯誤
   - **代理 #4**：分析引入程式碼中的潛在問題
5. 為每個發現的問題啟動驗證代理
6. 過濾掉未被驗證的問題
7. 輸出包含高信號問題的審查報告

**用法：**
```bash
# 審查最新提交
/code-review HEAD

# 審查特定提交
/code-review abc1234

# 審查提交範圍
/code-review main..feature-branch
/code-review HEAD~5..HEAD

# 審查多個提交
/code-review abc1234 def5678
```

**示例工作流程：**
```bash
# 在功能分支上開發完成後：
/code-review main..HEAD

# Claude 將：
# - 驗證提交範圍有效
# - 並行啟動 4 個審查代理
# - 驗證每個發現的問題
# - 輸出高信號問題報告
```

**報告格式示例：**

發現問題時：
```markdown
## Code review

發現 3 個問題：

1. OAuth 回調缺少錯誤處理（CLAUDE.md 說：「始終處理 OAuth 錯誤」）

   `1d54823877c4de72b2316a64032a54afc404e619:src/auth.ts#L67-L72`

   To view: `git show 1d54823877c4de72b2316a64032a54afc404e619:src/auth.ts | sed -n '67,72p'`

2. 內存洩漏：OAuth 狀態未清理（bug：finally 塊中缺少清理）

   `1d54823877c4de72b2316a64032a54afc404e619:src/auth.ts#L88-L95`

   To view: `git show 1d54823877c4de72b2316a64032a54afc404e619:src/auth.ts | sed -n '88,95p'`

Generated with Claude Code
```

未發現問題時：
```markdown
## Code review

未發現問題。已檢查錯誤和 CLAUDE.md 合規性。

Generated with Claude Code
```

## 功能特性

- **多代理並行審查**：4 個獨立代理確保全面性
- **驗證機制**：每個問題經過額外驗證以減少誤報
- **CLAUDE.md 合規性檢查**：明確驗證專案指南
- **錯誤檢測**：專注於變更中引入的問題（非預存問題）
- **預存問題過濾**：與基礎提交比較，排除既有問題
- **高信號輸出**：只報告經過驗證的真實問題
- **詳細引用**：提供完整 SHA、文件路徑和行範圍

## 過濾的誤報

此插件會自動過濾以下類型的問題：
- 預存問題（在提交範圍之前就存在的問題）
- 看起來像錯誤但實際上正確的程式碼
- 迂腐的吹毛求疵（資深工程師不會標記的）
- 檢查工具會捕獲的問題
- 一般程式碼質量問題（除非在 CLAUDE.md 中明確要求）
- 帶有 lint 忽略註釋的問題

## 安裝

此插件可透過 Claude Plugin Marketplace 安裝。安裝後，`/code-review` 命令將自動可用。

## 最佳實踐

### 使用 `/code-review`
- 維護清晰的 CLAUDE.md 文件以更好地進行合規性檢查
- 信任驗證過的問題 - 誤報已被過濾
- 在所有非瑣碎的提交上運行
- 將代理發現作為人工審查的起點
- 根據反覆出現的審查模式更新 CLAUDE.md

### 何時使用
- 合併功能分支前審查所有變更
- 大量程式碼變更需要審查時
- 確保遵循專案規範時
- 作為程式碼審查流程的第一步

### 何時不使用
- 只有單一文件的微小變更
- 僅格式化或重新縮排的變更
- 自動產生的程式碼
- 緊急修復需要立即合併時

## 工作流程整合

### 標準提交審查工作流程：
```bash
# 完成功能開發後
git add .
git commit -m "feat: add user authentication"

# 在推送前審查
/code-review HEAD

# 查看審查結果
# 根據需要進行修正
# 準備好後推送
git push
```

### 審查功能分支的所有變更：
```bash
# 切換到功能分支
git checkout feature-branch

# 審查從 main 分支以來的所有變更
/code-review main..HEAD

# 處理發現的問題
# 準備好後合併
```

### 審查特定範圍的提交：
```bash
# 審查最近 5 個提交
/code-review HEAD~5..HEAD

# 審查兩個特定提交之間的變更
/code-review abc1234..def5678
```

## 要求

- Git 儲存庫
- Git 命令行工具
- CLAUDE.md 文件（可選但建議用於指南檢查）

## 疑難排解

### 審查時間過長

**問題**：大量提交時代理速度緩慢

**解決方案**：
- 對於大量變更來說是正常的 - 代理並行運行
- 4 個獨立代理確保徹底性
- 考慮將審查範圍縮小

### 找不到提交

**問題**：指定的提交不存在

**解決方案**：
- 確認提交 SHA 正確
- 確認在正確的儲存庫中
- 使用 `git log` 查看可用的提交

### 提交範圍過大

**問題**：提交範圍包含超過 20 個提交

**解決方案**：
- 縮小審查範圍
- 或在提示時確認繼續
- 考慮分批審查

### 報告中的引用無法使用

**問題**：`git show` 命令失敗

**解決方案**：
- 確認在正確的儲存庫中
- 確認提交 SHA 完整（40 個字元）
- 確認文件路徑正確

## 技術細節

### 代理架構
- **2x CLAUDE.md 合規性代理（Sonnet）**：指南檢查的冗餘
- **1x 錯誤檢測器（Opus）**：專注於差異中的明顯錯誤
- **1x 問題分析器（Opus）**：尋找引入程式碼中的問題
- **Nx 驗證代理**：每個問題一個，用於獨立驗證

### 驗證系統
- 每個問題由專門的驗證代理審查
- 驗證代理獲得提交訊息和問題描述
- 與基礎提交比較以識別預存問題
- 對於 CLAUDE.md 問題：驗證規則適用性和實際違規

### Git 整合
使用以下 Git 命令：
- `git diff`：查看變更內容
- `git log`：獲取提交歷史和訊息
- `git show`：查看特定提交的文件內容
- `git blame`：追蹤程式碼歷史
- `git rev-parse`：解析提交引用
- `git ls-files`：列出追蹤的文件
- `git merge-base`：找出共同祖先

## 提示

- **編寫具體的 CLAUDE.md 文件**：清晰的指南 = 更好的審查
- **在提交訊息中包含上下文**：幫助代理理解意圖
- **使用驗證機制**：經過驗證的問題通常是正確的
- **迭代指南**：根據模式更新 CLAUDE.md
- **定期審查**：在合併前審查所有功能分支

## 配置

### 自定義審查重點

編輯 `commands/code-review.md` 以添加或修改代理任務：
- 添加注重安全性的代理
- 添加性能分析代理
- 添加可訪問性檢查代理
- 添加文檔質量檢查

### 調整誤報過濾

根據專案需求，可以在命令文件中調整誤報過濾列表。

## 作者

Dennis Liu (nossi1970@hotmail.com)

## 版本

1.0.0
