# Legacy Analyzer 插件

使用**多視角並行分析與置信度過濾法**分析 Legacy Java Spring Boot 專案，生成高質量的教學文件。

## 🎯 設計理念

本插件基於 **Code Review** 插件的成功方法論設計：

- ✅ **極簡架構**：只有 1 個 command，所有邏輯集中管理
- ✅ **臨時代理**：使用 Task 工具動態啟動代理，無需預定義
- ✅ **並行優先**：6 個分析代理 + N 個評分代理完全並行執行
- ✅ **置信度評分**：四維度量化評分（0-100），精確過濾低質量內容
- ✅ **防幻覺機制**：多層驗證確保所有引用都有證據支持
- ✅ **高效執行**：總時間約 7-9 分鐘（中型專案）


## 🌟 核心特色

### 1. 極簡設計

```
plugins/legacy-analyzer/
├── .claude-plugin/
│   └── plugin.json            # 插件元數據
├── README.md                  # 說明文件
└── commands/
    └── analyze-java.md        # 唯一的核心文件
```

### 2. 五階段流水線

```
階段 1: 資格預檢與快速掃描 (Haiku, 1分鐘)
   ↓
階段 2: 6個視角並行分析 (Sonnet, 3-4分鐘)
   ├─ 架構分析
   ├─ API 端點分析
   ├─ 資料流分析
   ├─ 業務邏輯分析
   ├─ 配置分析
   └─ 模式識別
   ↓
階段 3: N個代理並行評分 (Haiku, 10-20秒)
   - 證據強度 (40%)
   - 重要性 (30%)
   - 完整性 (15%)
   - 準確性 (15%)
   ↓
階段 4: 過濾與整合 (主Session, 30秒)
   - 閾值過濾 (>= 75)
   - 分類整合
   ↓
階段 5: 教學文件生成 (Sonnet, 2-3分鐘)
   - 完整 Markdown
   - Mermaid 圖表
   - 新手友善

總時間: 7-9分鐘
```

### 3. 置信度評分系統

每個發現都從四個維度評分：

**證據強度 (40%)** - 確保真實性
- 90-100: 有精確檔案路徑+行號，已驗證
- 70-89: 有檔案路徑，通過工具確認存在
- 50-69: 基本證據，需要進一步驗證
- 0-49: 證據不足或無效

**重要性 (30%)** - 確保價值
- 90-100: 核心業務邏輯，新手必知
- 70-89: 重要流程或設計模式
- 50-69: 輔助功能
- 0-49: 次要或瑣碎

**完整性 (15%)** - 確保可用性
- 90-100: 描述清晰，流程完整
- 70-89: 基本完整
- 0-69: 不完整或模糊

**準確性 (15%)** - 確保正確性
- 90-100: 技術描述完全正確
- 70-89: 基本準確
- 0-69: 有錯誤或幻覺

**最終分數**：`total = 證據*0.4 + 重要性*0.3 + 完整性*0.15 + 準確性*0.15`

**閾值過濾**：只保留 `total >= 75` 的發現（通常過濾掉 40-60%）

### 4. 多層防幻覺機制

**第一層：代理任務設計**
- 要求所有發現都有檔案路徑和行號
- 鼓勵使用 Read/Glob/Grep 驗證

**第二層：獨立評分驗證**
- 評分代理使用 Glob 驗證檔案存在
- 檢查描述與代碼匹配度

**第三層：閾值過濾**
- total_score >= 75
- evidence >= 60（強制）
- accuracy >= 50（強制）

**第四層：文件生成約束**
- 只使用高質量發現
- 不添加未驗證資訊

## 📦 安裝方式

### 方法 1：Git Clone（推薦）

```bash
cd ~/.claude/plugins
git clone https://github.com/DennisLiuCk/claude-plugin-marketplace.git
ln -s claude-plugin-marketplace/plugins/legacy-analyzer legacy-analyzer
```

### 方法 2：直接複製

```bash
cp -r /path/to/claude-plugin-marketplace/plugins/legacy-analyzer ~/.claude/plugins/
```

## 🚀 使用方式

### 基本用法

在 Java Spring Boot 專案根目錄執行：

```
/analyze-java
```

### 執行流程示例

```
使用者: /analyze-java

Claude:
╔═══════════════════════════════════════════════════════╗
║     Legacy Project Analyzer - 開始分析                ║
╚═══════════════════════════════════════════════════════╝

階段 1: 資格預檢與快速掃描
├─ 創建工作目錄: .legacy-analysis/session-20250125-143022/
├─ 檢查專案資格...
│  ✓ 檢測到 Spring Boot 2.7.12
│  ✓ 專案規模適中 (245 Java 檔案)
│  ✓ 符合分析條件
├─ 快速掃描專案結構...
│  ✓ 15 個 @RestController
│  ✓ 20 個 @Service
│  ✓ 12 個 @Repository
│  ✓ 10 個 @Entity
└─ 掃描完成，寫入: 01-project-scan.json

階段 2: 多視角並行分析
├─ 並行啟動 6 個分析代理...
│  ├─ 🔵 架構分析代理
│  ├─ 🟢 API 端點分析代理
│  ├─ 🟡 資料流分析代理
│  ├─ 🔵 業務邏輯分析代理
│  ├─ 🟠 配置分析代理
│  └─ 🟣 模式識別代理
│
├─ [等待 3-4 分鐘...]
│
├─ 所有代理完成！收集發現...
│  ├─ 架構分析: 15 個發現
│  ├─ API 端點: 25 個發現
│  ├─ 資料流: 18 個發現
│  ├─ 業務邏輯: 22 個發現
│  ├─ 配置: 10 個發現
│  └─ 模式識別: 12 個發現
│
└─ 總計: 102 個發現，寫入: 02-findings-raw.json

階段 3: 獨立置信度評分
├─ 並行啟動 102 個評分代理...
├─ [等待 10-20 秒...]
└─ 所有評分完成，寫入: 03-scores.json

階段 4: 過濾與結構化整合
├─ 應用閾值過濾 (score >= 75)...
│  ├─ 保留: 58 個高質量發現
│  ├─ 過濾: 44 個低質量發現
│  └─ 過濾率: 43.1%
│
├─ 結構化整合...
│  ├─ 架構發現: 8 個
│  ├─ API 端點: 15 個
│  ├─ 資料模型: 10 個
│  ├─ 業務邏輯: 12 個
│  ├─ 配置: 7 個
│  └─ 設計模式: 6 個
│
└─ 寫入: 04-findings-structured.json

階段 5: 教學文件生成
├─ 啟動文件生成代理...
├─ [等待 2-3 分鐘...]
├─ 生成完整的 Markdown 文件
│  ├─ 10 個主要章節
│  ├─ 15 個 Mermaid 圖表
│  ├─ 30+ 個程式碼範例
│  └─ 58 個可驗證的引用
│
└─ 寫入: 05-PROJECT-ANALYSIS.md

╔═══════════════════════════════════════════════════════╗
║       Legacy Project Analyzer - 分析完成               ║
╚═══════════════════════════════════════════════════════╝

✅ 所有階段已完成

📁 工作目錄: .legacy-analysis/session-20250125-143022/

📄 生成的文件:
  ├─ 01-project-scan.json          (專案掃描摘要)
  ├─ 02-findings-raw.json          (原始發現 102 個)
  ├─ 03-scores.json                (評分結果)
  ├─ 04-findings-structured.json   (結構化發現 58 個)
  ├─ 05-PROJECT-ANALYSIS.md        (最終教學文件) ⭐
  └─ session-stats.json            (統計資訊)

📊 分析統計:
  - 總執行時間: 7 分 15 秒
  - 代理調用: 109 次
  - 發現總數: 102 個
  - 高質量發現: 58 個 (56.9%)
  - 檔案路徑驗證率: 100%
  - 平均置信度分數: 82.5

🎯 下一步建議:
  1. 閱讀最終文件: 05-PROJECT-ANALYSIS.md
  2. 根據文件理解專案架構和核心流程
  3. 動手運行專案並對照文件調試

祝學習順利！ 🚀
```

## 📄 輸出文件說明

### 工作目錄結構

```
.legacy-analysis/
└── session-{timestamp}/
    ├── 01-project-scan.json          # 專案掃描摘要
    ├── 02-findings-raw.json          # 原始發現清單
    ├── 03-scores.json                # 評分結果
    ├── 04-findings-structured.json   # 結構化高質量發現
    ├── 05-PROJECT-ANALYSIS.md        # 最終教學文件 ⭐
    └── session-stats.json            # 統計資訊
```

### 最終教學文件內容

`05-PROJECT-ANALYSIS.md` 包含：

1. **專案概述** - 基本資訊、規模、結構
2. **快速開始** - 如何運行、開發環境
3. **架構說明** - 分層設計、Mermaid 架構圖
4. **API 端點清單** - 每個端點的詳細說明、序列圖、程式碼
5. **核心業務流程** - 重要流程的完整序列圖和說明
6. **資料模型** - Entity 關係圖（ER 圖）、欄位說明
7. **關鍵配置** - 資料庫、Spring Security、Bean 配置
8. **設計模式** - 識別出的模式和最佳實踐
9. **新手入門指南** - 學習路徑、常見任務、開發環境設置
10. **附錄** - 高質量發現清單、檔案路徑索引

**特色**：
- 完全使用繁體中文
- 假設讀者是新手，不要求先備知識
- 大量 Mermaid 圖表（架構圖、序列圖、ER 圖）
- 所有引用都有檔案路徑和行號
- 程式碼片段含註解
- 可點擊的檔案連結

## 🎓 方法論特色

### 1. 多視角並行分析

6 個專業代理從不同角度獨立分析：

| 代理 | 分析重點 | 輸出 |
|------|---------|------|
| 架構分析 | 分層設計、模組組織 | 8-15 個發現 |
| API 端點 | REST 端點、請求流程 | 15-25 個發現 |
| 資料流 | Entity、關聯、流轉 | 10-20 個發現 |
| 業務邏輯 | Service 層、業務規則 | 15-25 個發現 |
| 配置 | 配置文件、依賴、整合 | 8-15 個發現 |
| 模式識別 | 設計模式、最佳實踐 | 5-15 個發現 |

**優勢**：
- 完全並行執行（3-4 分鐘）
- 互不干擾，獨立判斷
- 全面覆蓋專案各面向
- 避免單一視角的盲點

### 2. 置信度驅動的質量保證

```
102 個原始發現
    ↓
[四維度評分: 證據 40% + 重要性 30% + 完整性 15% + 準確性 15%]
    ↓
[閾值過濾: >= 75, evidence >= 60, accuracy >= 50]
    ↓
58 個高質量發現 (過濾率 43%)
    ↓
[進入最終文件]
```

**效果**：
- 幻覺和猜測被過濾（evidence < 60）
- 不準確的內容被過濾（accuracy < 50）
- 瑣碎資訊被過濾（importance 低）
- 最終文件質量有保證

### 3. 模型選擇優化

| 任務類型 | 模型 | 原因 | 成本 |
|---------|------|------|------|
| 資格檢查 | Haiku | 簡單、快速 | 低 |
| 快速掃描 | Haiku | 結構化任務 | 低 |
| 深度分析 | Sonnet | 需要推理 | 中 |
| 置信度評分 | Haiku | 明確標準、數量多 | 低 |
| 文件生成 | Sonnet | 需要創造力 | 中 |

**成本優化**：
- Haiku 調用：約 103 次（檢查 + 掃描 + 評分）
- Sonnet 調用：約 7 次（6 個分析 + 1 個文件生成）
- 總成本：相比全用 Sonnet 節省約 60-70%

## ✅ 適用場景

### 適合使用

- ✅ 中小型 Spring Boot 專案（< 1000 Java 檔案）
- ✅ 新進工程師入職培訓
- ✅ 維護 legacy 系統前的快速理解
- ✅ 知識轉移和文件化
- ✅ 技術債務評估準備

### 不適合

- ❌ 非 Java 或非 Spring Boot 專案
- ❌ 超大型專案（> 1000 Java 檔案）- 建議分模組分析
- ❌ 需要深度業務邏輯分析 - 此工具重點在架構和流程
- ❌ 需要運行時分析 - 此工具基於靜態代碼分析

## 🔧 技術要求

### 分析目標專案

- **框架**：Spring Boot 2.x / 3.x
- **建構工具**：Maven 或 Gradle
- **專案結構**：標準 Spring Boot 結構（src/main/java）
- **規模**：< 1000 Java 檔案

### 執行環境

- Claude Code CLI
- 本插件已安裝

## 📊 效能指標

### 執行效能

- **總執行時間**：7-9 分鐘（中型專案，245 檔案）
- **代理調用次數**：約 109 次
- **並行化程度**：95%（階段 2 和 3 完全並行）

### 質量指標

- **檔案路徑驗證率**：通常 > 95%
- **平均置信度分數**：約 80-85
- **過濾率**：40-60%（代表評分有效）


## 📚 延伸閱讀

### 設計理念

1. **極簡主義**：一個 command 解決所有問題
2. **臨時代理**：動態啟動，無需維護多個 agent 文件
3. **並行優先**：最大化並行執行，提高效率
4. **置信度驅動**：量化評分，精確過濾
5. **防禦性設計**：多層防護，確保質量

### 相關插件

- **code-review**：本插件的方法論來源

## 🐛 疑難排解

### 問題：分析時間過長

**原因**：專案過大（> 1000 檔案）

**解決**：
- 分模組分析（指定特定 package）
- 或接受較長的分析時間

### 問題：發現數量太少

**原因**：閾值過高或專案過於簡單

**解決**：
- 檢查過濾率是否過高（> 70%）
- 檢查 02-findings-raw.json 中的原始發現
- 如果專案確實簡單，這是正常的

### 問題：文件中缺少某些模組

**原因**：該模組沒有高質量發現（分數 < 75）

**解決**：
- 檢查 02-findings-raw.json 和 03-scores.json
- 手動補充遺漏的模組文件
- 考慮調整閾值（但不建議低於 70）

### 問題：檔案路徑連結失效

**原因**：相對路徑設置問題

**解決**：
- 確保在專案根目錄執行命令
- 檢查文件中的路徑格式

## 📝 版本資訊

- **版本**：1.0.0
- **作者**：Dennis Liu
- **基於**：Code Review 插件方法論
- **適用**：Java Spring Boot 2.x / 3.x
- **最後更新**：2025-11-25

## 📄 授權

此插件基於 Anthropic 官方 claude-code 插件開發，採用相同授權條款。

## 🙏 致謝

特別感謝 Code Review 插件的設計，為本插件提供了優秀的方法論範本。
