# Issue Review 插件

> 專業的問題分析專家系統，從不完整的問題描述到精確的根本原因定位

## 📋 概述

Issue Review 是一個系統化的問題分析插件，能夠深入分析各類軟體問題、調查程式碼庫、定位根本原因並提供解決方案。無論問題描述多麼簡短或模糊，它都能通過三個專門的分析代理協同工作，逐步深入，最終找出問題的真正源頭。

### 適用場景

- **PM/使用者報告的線上問題**：描述可能不完整，缺少技術細節
- **前端開發者反映的問題**：UI 異常、互動問題、渲染錯誤
- **後端開發者報告的問題**：API 錯誤、資料處理異常、效能問題
- **測試團隊發現的 Bug**：測試環境中的異常行為
- **生產環境告警**：監控系統捕獲的錯誤和異常

### 核心價值

✅ **處理不完整資訊**：即使只有簡短的問題描述，也能系統化分析
✅ **多階段深入分析**：從問題理解 → 程式碼調查 → 根本原因定位
✅ **客觀評分機制**：為每個可能原因評分，優先分析最可能的
✅ **迭代驗證假設**：逐一驗證假設，避免過早下結論
✅ **清晰的報告**：技術和非技術人員都能理解的分析報告

---

## 🎯 功能特色

### 1. 三階段分析流程

```
階段 1: 問題分析
  ↓ problem-analyzer 代理
  • 提取已知資訊
  • 識別資訊缺口
  • 制定調查方向

階段 2: 程式碼庫調查
  ↓ codebase-investigator 代理
  • 定位相關程式碼
  • 追蹤執行流程
  • 識別可能原因（附評分）

階段 3: 根本原因定位（迭代）
  ↓ root-cause-finder 代理
  • 深入驗證假設
  • 建立因果鏈
  • 確認根本原因
```

### 2. 智慧評分系統

每個可能原因都會獲得 0-100 分的可能性評分：

- **90-100 分**：幾乎確定（Very High Confidence）
- **75-89 分**：高度可能（High Confidence）
- **60-74 分**：相當可能（Medium-High Confidence）
- **45-59 分**：可能（Medium Confidence）
- **30-44 分**：較低可能（Low-Medium Confidence）
- **0-29 分**：不太可能（Low Confidence）

### 3. 專門的分析代理

#### problem-analyzer（黃色）
- **專長**：問題資訊提取、分類、初步假設
- **模型**：Sonnet
- **工具**：Read, Glob, Grep, Bash, TodoWrite

#### codebase-investigator（藍色）
- **專長**：程式碼定位、流程追蹤、可能性評估
- **模型**：Sonnet
- **工具**：Glob, Grep, Read, Bash, TodoWrite

#### root-cause-finder（紫色）
- **專長**：假設驗證、邏輯推演、根本原因確認
- **模型**：Sonnet
- **工具**：Read, Glob, Grep, Bash, TodoWrite

### 4. 完整的工作流程控制

- **自動階段轉換**：自動從一個階段進入下一階段
- **迭代驗證**：從最高可能性開始，逐一驗證假設
- **智慧停止**：找到確定的 root cause 後停止迭代
- **使用者互動**：關鍵決策點詢問使用者意見

---

## 🚀 快速開始

### 安裝

1. 確保已安裝 [Claude Code](https://claude.ai/code)

2. 安裝此插件：
```bash
# 方法 1：從市場安裝（推薦）
claude plugin install issue-review

# 方法 2：從本地安裝
cd /path/to/claude-plugin-marketplace/plugins/issue-review
claude plugin install .
```

3. 驗證安裝：
```bash
claude plugin list | grep issue-review
```

### 基本使用

啟動 issue-review skill：

```
/skill issue-review

# 或直接調用代理
# 分析問題描述
使用 problem-analyzer 代理分析這個問題：「訂單提交時頁面卡住了」

# 調查程式碼庫
使用 codebase-investigator 代理調查訂單提交相關的程式碼

# 驗證特定假設
使用 root-cause-finder 代理驗證這個假設：API 請求超時
```

---

## 📖 使用指南

### 完整工作流程範例

**情境**：使用者報告「提交訂單時頁面卡住」

#### 步驟 1：啟動技能

```
我要分析一個問題，請使用 issue-review 技能。

問題描述：
使用者說他們在提交訂單時，點擊送出按鈕後頁面卡住了，
等了很久都沒反應。有時候重新整理後可以看到訂單有建立成功，
有時候沒有。
```

#### 步驟 2：自動執行分析流程

**階段 1 - 問題分析**

Claude 會啟動 `problem-analyzer` 代理：

```
[problem-analyzer 分析中...]

問題分析報告：
📋 問題摘要
- 類型：前端/後端整合問題
- 嚴重程度：High
- 緊急程度：P1

🎯 調查方向
1. API 請求超時（可能性 85%）
2. Loading 狀態未重置（可能性 70%）
3. 後端處理時間過長（可能性 65%）

✅ 階段 1 完成，開始調查程式碼庫...
```

**階段 2 - 程式碼庫調查**

Claude 會啟動 `codebase-investigator` 代理：

```
[codebase-investigator 調查中...]

程式碼庫調查報告：
🗺️ 程式碼地圖
- 前端進入點：OrderForm.tsx:45 handleSubmit()
- 後端進入點：orderController.ts:23 createOrder()

🔄 執行流程
[顯示完整的前端 → 後端流程圖，標註 7 個潛在問題點]

🎯 可能原因排序
1. API 請求未設定 timeout（85/100）- orderService.ts:34
2. Loading 狀態未正確重置（73/100）- OrderForm.tsx:67
3. 後端處理時間過長（70/100）- orderService.ts:45

✅ 階段 2 完成，開始驗證根本原因...
```

**階段 3 - 根本原因定位（迭代）**

Claude 會啟動 `root-cause-finder` 代理分析原因 #1：

```
[root-cause-finder 分析原因 #1...]

✅ Root Cause 已確認！（信心度：96%）

🎯 根本原因
位置：src/services/orderService.ts:34
問題：fetch() API 呼叫未設定 timeout

🔗 完整因果鏈
fetch() 未設定 timeout
  ↓ 導致
當伺服器回應緩慢時，Promise 永遠不會 resolve/reject
  ↓ 導致
OrderForm 元件的 async 函式永遠不會完成
  ↓ 導致
loading 狀態無法更新為 false
  ↓ 表現為
頁面卡住，使用者無法操作

✅ 階段 3 完成
```

#### 步驟 3：選擇性驗證

```
問題根本原因已定位！

是否需要我創建一個簡單的測試案例來驗證這個問題？(是/否)

> 是

[創建測試案例...]
測試程式碼已創建在：tests/orderSubmitTimeout.test.ts
```

#### 步驟 4：獲得最終報告

```
[生成最終報告...]

# 🎯 Issue Review 分析報告

## 執行摘要
問題：訂單提交時頁面卡住
Root Cause：API 請求未設定 timeout
修復：添加 10 秒 timeout 和錯誤處理

## 根本原因
**位置**：`src/services/orderService.ts:34`
fetch() API 呼叫未設定 timeout，導致伺服器回應緩慢時請求永遠等待。

## 修復建議
[提供完整的修復程式碼]

## 驗證方法
[提供 3 種驗證方法]

✅ 分析完成！
```

---

## 🎨 代理詳細說明

### problem-analyzer（問題分析專家）

**何時使用**：
- 收到新的問題報告
- 需要理解問題本質
- 資訊不完整或模糊

**工作內容**：
1. **資訊提取**
   - 問題現象、預期行為
   - 環境資訊、重現步驟
   - 錯誤訊息、影響範圍

2. **問題分類**
   - 類型：前端/後端/資料/整合/效能/安全/配置
   - 嚴重程度：Critical/High/Medium/Low
   - 緊急程度：P0/P1/P2/P3

3. **初步假設**
   - 列出 3-5 個可能原因
   - 為每個假設評估可能性
   - 制定調查方向

**輸出範例**：
```markdown
# 問題分析報告

## 📋 問題摘要
訂單提交時頁面無回應，訂單建立狀態不一致

## 🔍 已知資訊
- 問題現象：點擊送出按鈕後頁面卡住
- 預期行為：應該顯示載入指示器和成功訊息
- 環境：[部分未知]

## 🎯 調查方向
1. API 請求超時（85%）
2. Loading 狀態未重置（70%）
3. 後端處理過長（65%）
```

**直接調用**：
```
使用 problem-analyzer 代理分析以下問題：

[貼上問題描述]
```

---

### codebase-investigator（程式碼庫調查專家）

**何時使用**：
- 已完成問題分析
- 需要定位相關程式碼
- 需要找出所有可能原因

**工作內容**：
1. **定位相關程式碼**
   - 找到進入點（API、事件處理器）
   - 識別關鍵檔案
   - 建立程式碼地圖

2. **追蹤執行流程**
   - 前端流程：互動 → 狀態 → API → UI
   - 後端流程：路由 → 控制器 → 服務 → 資料
   - 標註所有潛在問題點

3. **識別可能原因**
   - 邏輯錯誤、狀態管理問題
   - 錯誤處理缺失、效能問題
   - 為每個原因評分（0-100）

4. **優先級排序**
   - 按可能性評分排序
   - 提供詳細的程式碼位置

**輸出範例**：
```markdown
# 程式碼庫調查報告

## 🗺️ 程式碼地圖
**前端進入點**：OrderForm.tsx:45 handleSubmit()
**後端進入點**：orderController.ts:23 createOrder()

## 🔄 執行流程追蹤
使用者點擊按鈕
  ↓ OrderForm.tsx:45
設定 loading
  ↓ OrderForm.tsx:67 (⚠️ 問題點 1)
發送 API 請求
  ↓ orderService.ts:34 (⚠️ 問題點 2)
[等待回應...]

## 🎯 可能原因分析
### 原因 #1：API 請求未設定 timeout（85/100）
- 位置：orderService.ts:34
- 症狀匹配度：30/30
- 邏輯分析：30/30
- [詳細評分...]
```

**直接調用**：
```
使用 codebase-investigator 代理調查訂單提交功能的相關程式碼
```

---

### root-cause-finder（根本原因定位專家）

**何時使用**：
- 已識別出可能原因列表
- 需要深入驗證特定假設
- 需要確認根本原因

**工作內容**：
1. **深入程式碼審查**
   - 完整閱讀相關程式碼
   - 理解函式邏輯和意圖
   - 追蹤變數和狀態

2. **邏輯推演**
   - 模擬正常情況的執行
   - 模擬問題情況的執行
   - 識別邏輯分歧點

3. **證據收集**
   - 程式碼證據（邏輯缺陷）
   - 歷史證據（Git 歷史）
   - 配置證據（環境變數）

4. **假設驗證**
   - ✅ 確認：Root Cause Found
   - ❓ 部分確認：需要更多資訊
   - ❌ 排除：繼續下一個假設

5. **建立因果鏈**
   - 根本原因 → 中間影響 → 直接原因 → 表面症狀

**輸出範例**：
```markdown
# 根本原因分析報告

## ✅ 結論：Root Cause 已確認（96%）

## 🎯 根本原因
**位置**：src/services/orderService.ts:34
**問題**：fetch() 未設定 timeout

**程式碼分析**：
```typescript
// orderService.ts:34-42
export const createOrder = async (orderData) => {
  const response = await fetch('/api/orders', {
    method: 'POST',
    body: JSON.stringify(orderData),
  });
  // ❌ 缺少 timeout 設定
  return response.json();
};
```

## 🔗 完整因果鏈
[根本原因] fetch() 未設定 timeout
  ↓ 導致
[中間影響 1] Promise pending 狀態永遠不會結束
  ↓ 導致
[直接原因] loading 狀態無法更新
  ↓ 表現為
[表面症狀] 頁面卡住

## 💡 為何確認這是 Root Cause
✅ 邏輯確認：fetch 行為完全符合
✅ 症狀匹配：100% 匹配所有症狀
✅ 支持證據：程式碼、歷史、環境證據充分
✅ 無矛盾證據
✅ 可修復性：修復方案明確

## 🔧 修復建議
[提供完整的修復程式碼和說明]
```

**直接調用**：
```
使用 root-cause-finder 代理驗證以下假設：

假設：API 請求未設定 timeout 導致頁面卡住
位置：orderService.ts:34
```

---

## 🔧 進階使用

### 單獨使用代理

雖然推薦使用完整的 issue-review skill，但你也可以單獨調用代理：

```
# 只分析問題，不深入調查程式碼
請使用 problem-analyzer 代理，分析這個問題並制定調查方向：
[問題描述]

# 只調查特定模組的程式碼
請使用 codebase-investigator 代理，調查認證系統的程式碼，
找出可能導致登入失敗的原因。

# 只驗證特定假設
請使用 root-cause-finder 代理，驗證這個假設：
資料庫連線池耗盡導致請求超時
```

### 處理複雜場景

#### 場景 1：多個併發問題

```
問題描述很複雜，包含 3 個不同的症狀：
1. 訂單提交有時失敗
2. 使用者資料有時顯示錯誤
3. 頁面載入很慢

請使用 issue-review 分析，並識別這些是同一個 root cause
還是多個獨立問題。
```

#### 場景 2：間歇性問題

```
問題只在特定時間發生（例如每天早上 9-10 點），
其他時間正常。

請使用 issue-review 分析，重點關注：
- 時間相關性（定時任務、負載高峰）
- 競態條件
- 資源限制
```

#### 場景 3：環境特定問題

```
問題只在生產環境發生，開發和測試環境都正常。

請使用 issue-review 分析，重點檢查：
- 環境變數差異
- 配置檔案差異
- 資料量差異
- 第三方服務差異
```

---

## 📊 評分系統詳解

### 可能性評分（codebase-investigator）

**評分維度**：

1. **症狀匹配度**（0-30 分）
   - 30 分：完全匹配所有症狀
   - 20 分：匹配主要症狀
   - 10 分：部分匹配
   - 0 分：不匹配

2. **程式碼邏輯分析**（0-30 分）
   - 30 分：確定有邏輯缺陷
   - 20 分：高度可能有缺陷
   - 10 分：可能有問題
   - 0 分：邏輯正確

3. **歷史證據**（0-20 分）
   - 20 分：最近修改且有相關歷史
   - 10 分：最近修改或有相關歷史
   - 0 分：無相關歷史

4. **環境/配置相關性**（0-20 分）
   - 20 分：高度環境相關
   - 10 分：可能環境相關
   - 0 分：與環境無關

**範例**：
```
原因：API 請求未設定 timeout
- 症狀匹配度：30/30（完全匹配「頁面卡住」「等待很久」「間歇性」）
- 邏輯分析：30/30（確定缺少 timeout）
- 歷史證據：15/20（最近有修改）
- 環境相關性：10/20（與網路環境相關）
- 總分：85/100
```

### 信心度等級（root-cause-finder）

**High Confidence（90-100%）**：
- 邏輯確定性強
- 症狀 100% 匹配
- 證據充分且無矛盾
- 修復方案明確

**Medium Confidence（60-89%）**：
- 邏輯基本成立
- 症狀大部分匹配
- 有支持證據但不完整
- 可能需要更多驗證

**Low Confidence（<60%）**：
- 邏輯推測性強
- 症狀部分匹配
- 證據不足
- 需要更多資訊

---

## 🎓 最佳實踐

### 1. 提供充分的問題描述

**好的問題描述**：
```
使用者報告：在提交訂單時，點擊「送出」按鈕後頁面卡住，
載入指示器一直轉圈，等了 2-3 分鐘都沒反應。

重新整理頁面後，有時候可以看到訂單已經建立成功，
有時候沒有訂單記錄。

環境：Chrome 120, 生產環境
頻率：大約每 10 次提交會發生 2-3 次
時間：主要發生在下午 2-4 點（業務高峰期）

瀏覽器控制台沒有明顯的錯誤訊息。
```

**不好的問題描述**：
```
訂單有問題
```

### 2. 循序漸進地提供資訊

如果一開始資訊不足，可以分階段提供：

```
階段 1：提供初步描述
> 訂單提交有問題

階段 2：根據 problem-analyzer 的詢問補充
> 症狀：頁面卡住
> 環境：Chrome, 生產環境
> 頻率：偶爾發生

階段 3：提供額外發現
> 剛查了日誌，發現有 timeout 錯誤
```

### 3. 善用代理的專長

- **problem-analyzer**：當你不確定問題的性質時
- **codebase-investigator**：當你知道問題區域但不確定具體位置時
- **root-cause-finder**：當你有明確的假設需要驗證時

### 4. 驗證修復

找到 root cause 後，建議：

1. **程式碼審查**：請其他開發者審查分析結果
2. **本地驗證**：在本地環境重現和驗證
3. **測試案例**：創建測試案例防止回歸
4. **監控告警**：添加監控防止類似問題

### 5. 記錄分析過程

將分析報告保存為文檔：
- 幫助團隊學習
- 建立問題知識庫
- 改進開發流程

---

## 🐛 疑難排解

### 問題：找不到根本原因

**可能原因**：
1. 資訊不足
2. 問題已在新版本中修復
3. 問題是多個原因共同導致

**解決方案**：
```
1. 提供更多資訊：
   - 伺服器日誌
   - 詳細的重現步驟
   - 瀏覽器開發者工具截圖

2. 檢查最近的程式碼變更：
   git log --since="1 week ago" --oneline

3. 嘗試分階段分析：
   先用 problem-analyzer 列出所有可能性
   然後逐一使用 root-cause-finder 驗證
```

### 問題：分析結果不準確

**可能原因**：
1. 問題描述有誤
2. 程式碼庫結構複雜
3. 罕見的邊緣案例

**解決方案**：
```
1. 確認問題描述準確性
2. 提供更多上下文資訊
3. 手動檢查高可能性的原因
4. 結合日誌和監控資料
```

### 問題：代理回應太長

**解決方案**：
```
# 使用更具體的問題描述
使用 problem-analyzer 分析這個問題，重點關注 API 層

# 或要求簡潔輸出
使用 root-cause-finder 驗證這個假設，只需要結論和關鍵證據
```

---

## 📚 範例集錦

### 範例 1：前端狀態管理問題

**問題**：
```
使用者資料頁面在快速切換分頁時，偶爾會看到上一個分頁的資料閃現。
錯誤：Warning: Can't perform a React state update on an unmounted component
```

**分析結果**：
```
Root Cause：useEffect 缺少清理函式
位置：UserProfilePage.tsx:34
修復：添加 cleanup function 取消未完成的請求
```

### 範例 2：後端效能問題

**問題**：
```
某些使用者報告 API 回應很慢（>10 秒），但大部分使用者正常（<1 秒）。
```

**分析結果**：
```
Root Cause：N+1 查詢問題
位置：orderRepository.ts:45
修復：使用 JOIN 或預先載入關聯資料
```

### 範例 3：資料一致性問題

**問題**：
```
訂單有時會建立兩筆重複的記錄。
```

**分析結果**：
```
Root Cause：缺少防重複提交機制
位置：
- 前端：OrderForm.tsx:67（未禁用按鈕）
- 後端：orderController.ts:23（未檢查重複）
修復：前端禁用按鈕 + 後端冪等性保護
```

---

## 🔍 技術細節

### 工作流程控制

Issue Review 使用狀態機模式控制工作流程：

```
初始狀態
  ↓ 啟動
階段 1: 問題分析
  ↓ 完成
階段 2: 程式碼調查
  ↓ 完成
階段 3: 根本原因定位（迭代）
  ├─ 確認 → 階段 4（可選驗證）
  ├─ 部分確認 → 繼續迭代
  └─ 排除 → 繼續迭代
       ↓ 所有假設已驗證或找到 root cause
階段 5: 最終報告
  ↓
完成狀態
```

### 代理協調

使用 Task 工具啟動代理：
```typescript
// 啟動 problem-analyzer
使用 problem-analyzer 代理...

// 等待代理完成，獲取輸出
// 將輸出作為下一階段的輸入

// 啟動 codebase-investigator
使用 codebase-investigator 代理...

// 迭代啟動 root-cause-finder
for (const hypothesis of hypotheses) {
  使用 root-cause-finder 代理驗證假設...
  if (result === 'confirmed') break;
}
```

### 資料流動

```
使用者輸入
  ↓
problem-analyzer
  ├─ 問題摘要
  ├─ 初步假設列表
  └─ 調查方向
      ↓
codebase-investigator
  ├─ 程式碼地圖
  ├─ 執行流程
  └─ 可能原因列表（附評分）
      ↓
root-cause-finder（迭代）
  ├─ 假設驗證結果
  ├─ 因果鏈
  └─ 修復建議
      ↓
最終報告
```

---

## 🤝 貢獻指南

歡迎貢獻改進！

### 報告問題

如果發現 bug 或有功能建議：
1. 檢查是否已有類似的 issue
2. 創建新的 issue，描述：
   - 問題或建議的詳細描述
   - 重現步驟（如果是 bug）
   - 預期行為
   - 實際行為

### 改進代理

如果想改進代理的分析能力：
1. 修改對應的代理檔案（agents/*.md）
2. 更新 prompt 或分析邏輯
3. 測試改進效果
4. 提交 PR

### 添加範例

歡迎添加更多使用範例到此 README。

---

## 📝 版本資訊

### v1.0.0（當前版本）

**初始發布**：
- ✅ 三個專門分析代理
- ✅ 完整的工作流程控制
- ✅ 智慧評分系統
- ✅ 迭代驗證機制
- ✅ 詳細的分析報告

**已知限制**：
- 依賴高質量的問題描述
- 複雜的分散式系統問題可能需要更多人工分析
- 評分系統基於啟發式規則，可能需要調整

**未來規劃**：
- [ ] 添加歷史問題資料庫，學習常見問題模式
- [ ] 支援自動執行驗證測試
- [ ] 整合監控系統資料
- [ ] 支援團隊協作分析

---

## 🔗 相關資源

### Claude Code 官方文檔
- [Claude Code 插件開發](https://docs.claude.com/en/docs/claude-code/plugins)
- [代理系統](https://docs.claude.com/en/docs/claude-code/agents)
- [技能系統](https://docs.claude.com/en/docs/claude-code/skills)

### 相關插件
- **code-review**：程式碼審查自動化
- **feature-dev**：功能開發工作流程
- **pr-review-toolkit**：PR 審查工具包

### 學習資源
- [系統化問題診斷方法](https://sre.google/sre-book/effective-troubleshooting/)
- [根本原因分析技術](https://en.wikipedia.org/wiki/Root_cause_analysis)

---

## 📄 授權

本插件基於 Anthropic 官方插件架構開發，遵循相同的開源協議。

---

## 👥 作者

**Dennis Liu（繁體中文版）**
- Email: dennisliuck@gmail.com
- GitHub: [@DennisLiuCk](https://github.com/DennisLiuCk)

---

## 🙏 致謝

感謝 Anthropic 提供的 Claude Code 平台和官方插件範例。

本插件的設計參考了以下官方插件的優秀實踐：
- `code-review`：評分機制和並行分析
- `feature-dev`：多階段工作流程和代理協調
- `pr-review-toolkit`：專業化代理設計

---

**準備好開始分析問題了嗎？**

```
/skill issue-review
```

讓我們一起找出問題的根本原因！🔍
