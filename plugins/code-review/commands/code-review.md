---
allowed-tools: Bash(gh issue view:*), Bash(gh search:*), Bash(gh issue list:*), Bash(gh pr comment:*), Bash(gh pr diff:*), Bash(gh pr view:*), Bash(gh pr list:*)
description: 對拉取請求進行代碼審查
disable-model-invocation: false
---

為給定的拉取請求提供代碼審查。

要執行此操作，請精確遵循以下步驟：

1. 使用 Haiku 代理檢查拉取請求是否（a）已關閉，（b）是草稿，（c）不需要代碼審查（例如，因為它是自動化拉取請求，或者非常簡單且明顯沒問題），或（d）已經有您之前的代碼審查。如果是這樣，請不要繼續。
2. 使用另一個 Haiku 代理為您提供代碼庫中任何相關 CLAUDE.md 文件的文件路徑列表（但不是內容）：根 CLAUDE.md 文件（如果存在），以及拉取請求修改的文件所在目錄中的任何 CLAUDE.md 文件
3. 使用 Haiku 代理查看拉取請求，並要求代理返回變更的摘要
4. 然後，啟動 5 個並行 Sonnet 代理來獨立審查變更。代理應執行以下操作，然後返回問題列表以及標記每個問題的原因（例如，CLAUDE.md 遵守情況、錯誤、歷史 git 上下文等）：
   a. 代理 #1：審計變更以確保它們符合 CLAUDE.md。請注意，CLAUDE.md 是 Claude 編寫代碼時的指導，因此並非所有指令在代碼審查期間都適用。
   b. 代理 #2：讀取拉取請求中的文件變更，然後對明顯的錯誤進行淺層掃描。避免閱讀變更之外的額外上下文，只關注變更本身。關注大的錯誤，避免小問題和吹毛求疵。忽略可能的誤報。
   c. 代理 #3：讀取修改代碼的 git blame 和歷史記錄，以根據該歷史上下文識別任何錯誤
   d. 代理 #4：讀取涉及這些文件的先前拉取請求，並檢查這些拉取請求上的任何評論是否也適用於當前拉取請求。
   e. 代理 #5：讀取修改文件中的代碼註釋，並確保拉取請求中的變更符合註釋中的任何指導。
5. 對於 #4 中發現的每個問題，啟動一個並行 Haiku 代理，該代理接收 PR、問題描述和 CLAUDE.md 文件列表（來自步驟 2），並返回一個分數以指示代理對問題是真實問題還是誤報的置信度。為此，代理應在 0-100 的範圍內為每個問題評分，指示其置信度。對於由於 CLAUDE.md 指令而標記的問題，代理應仔細檢查 CLAUDE.md 是否確實專門指出了該問題。評分標準是（逐字將此評分標準提供給代理）：
   a. 0：完全不確定。這是一個經不起輕微審查的誤報，或者是一個預存問題。
   b. 25：有點確定。這可能是一個真實的問題，但也可能是誤報。代理無法驗證這是一個真實的問題。如果問題是風格性的，則是未在相關 CLAUDE.md 中明確指出的問題。
   c. 50：中等確定。代理能夠驗證這是一個真實的問題，但可能是吹毛求疵或在實踐中不常發生。相對於 PR 的其餘部分，它不是很重要。
   d. 75：高度確定。代理仔細檢查了問題，並驗證了它很可能是一個在實踐中會遇到的真實問題。PR 中的現有方法不足。該問題非常重要，將直接影響代碼的功能，或者是相關 CLAUDE.md 中直接提到的問題。
   e. 100：絕對確定。代理仔細檢查了問題，並確認它絕對是一個真實的問題，在實踐中會經常發生。證據直接確認了這一點。
6. 過濾掉評分低於 80 的任何問題。如果沒有符合此標準的問題，請不要繼續。
7. 使用 Haiku 代理重複 #1 中的資格檢查，以確保拉取請求仍然有資格進行代碼審查。
8. 最後，使用 gh bash 命令在拉取請求上評論結果。在編寫評論時，請記住：
   a. 保持輸出簡潔
   b. 避免使用表情符號
   c. 鏈接並引用相關代碼、文件和 URL

步驟 4 和 5 的誤報示例：

- 預存問題
- 看起來像錯誤但實際上不是錯誤的東西
- 高級工程師不會指出的迂腐吹毛求疵
- 檢查工具、類型檢查器或編譯器會捕獲的問題（例如，缺少或不正確的導入、類型錯誤、測試失敗、格式問題、換行符等迂腐風格問題）。無需自己運行這些構建步驟 -- 可以安全地假設它們將作為 CI 的一部分單獨運行。
- 一般代碼質量問題（例如，缺少測試覆蓋率、一般安全問題、文檔不足），除非在 CLAUDE.md 中明確要求
- CLAUDE.md 中指出但在代碼中明確禁用的問題（例如，由於 lint 忽略註釋）
- 可能是有意的或與更廣泛的變更直接相關的功能變更
- 真實問題，但在用戶未在其拉取請求中修改的行上

注意事項：

- 不要檢查構建信號或嘗試構建或類型檢查應用程式。這些將單獨運行，與您的代碼審查無關。
- 使用 `gh` 與 Github 互動（例如，獲取拉取請求或創建內聯評論），而不是 web fetch
- 首先制定待辦事項列表
- 您必須引用並鏈接每個錯誤（例如，如果引用 CLAUDE.md，您必須鏈接它）
- 對於您的最終評論，請精確遵循以下格式（假設本例中您發現了 3 個問題）：

---

### 代碼審查

發現 3 個問題：

1. <錯誤簡要描述>（CLAUDE.md 說"<...>"）

<鏈接到帶有完整 sha1 + 上下文行範圍的文件和行，請注意您必須提供完整的 sha 而不是在此處使用 bash，例如 https://github.com/anthropics/claude-code/blob/1d54823877c4de72b2316a64032a54afc404e619/README.md#L13-L17>

2. <錯誤簡要描述>（some/other/CLAUDE.md 說"<...>"）

<鏈接到帶有完整 sha1 + 上下文行範圍的文件和行>

3. <錯誤簡要描述>（由於 <文件和代碼片段> 而導致的錯誤）

<鏈接到帶有完整 sha1 + 上下文行範圍的文件和行>

🤖 使用 [Claude Code](https://claude.ai/code) 生成

<sub>- 如果此代碼審查有用，請用 👍 反應。否則，用 👎 反應。</sub>

---

- 或者，如果您沒有發現問題：

---

### 代碼審查

未發現問題。已檢查錯誤和 CLAUDE.md 合規性。

🤖 使用 [Claude Code](https://claude.ai/code) 生成

- 鏈接到代碼時，請精確遵循以下格式，否則 Markdown 預覽將無法正確渲染：https://github.com/anthropics/claude-cli-internal/blob/c21d3c10bc8e898b7ac1a2d745bdc9bc4e423afe/package.json#L10-L15
  - 需要完整的 git sha
  - 您必須提供完整的 sha。像 `https://github.com/owner/repo/blob/$(git rev-parse HEAD)/foo/bar` 這樣的命令將不起作用，因為您的評論將直接在 Markdown 中渲染。
  - 存儲庫名稱必須與您正在審查的存儲庫匹配
  - 文件名後的 # 符號
  - 行範圍格式為 L[開始]-L[結束]
  - 提供至少 1 行上下文，在您評論的行之前和之後，以您評論的行為中心（例如，如果您評論第 5-6 行，則應鏈接到 `L4-7`）
