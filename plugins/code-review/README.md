# 代碼審查插件

使用多個專業代理對拉取請求進行自動化代碼審查，通過基於置信度的評分來過濾誤報。

## 概述

代碼審查插件通過並行啟動多個代理從不同角度獨立審計變更來自動化拉取請求審查。它使用置信度評分來過濾誤報，確保只發布高質量、可操作的反饋。

## 命令

### `/code-review`

使用多個專業代理對拉取請求執行自動化代碼審查。

**功能：**
1. 檢查是否需要審查（跳過已關閉、草稿、瑣碎或已審查的 PR）
2. 從存儲庫中收集相關的 CLAUDE.md 指南文件
3. 總結拉取請求的變更
4. 啟動 4 個並行代理進行獨立審查：
   - **代理 #1 和 #2**：審計 CLAUDE.md 合規性
   - **代理 #3**：掃描變更中的明顯錯誤
   - **代理 #4**：分析 git blame/歷史記錄以查找基於上下文的問題
5. 為每個問題評分 0-100 的置信度
6. 過濾掉低於 80 置信度閾值的問題
7. 僅發布包含高置信度問題的審查評論

**用法：**
```bash
/code-review
```

**示例工作流程：**
```bash
# 在 PR 分支上運行：
/code-review

# Claude 將：
# - 並行啟動 4 個審查代理
# - 為每個問題評分置信度
# - 發布置信度 ≥80 的問題評論
# - 如果沒有發現高置信度問題則跳過發布
```

**功能特性：**
- 多個獨立代理進行全面審查
- 基於置信度的評分減少誤報（閾值：80）
- CLAUDE.md 合規性檢查，明確驗證指南
- 錯誤檢測專注於變更（而非預存問題）
- 通過 git blame 進行歷史上下文分析
- 自動跳過已關閉、草稿或已審查的 PR
- 直接鏈接到帶有完整 SHA 和行範圍的代碼

**審查評論格式：**
```markdown
## 代碼審查

發現 3 個問題：

1. OAuth 回調缺少錯誤處理（CLAUDE.md 說"始終處理 OAuth 錯誤"）

https://github.com/owner/repo/blob/abc123.../src/auth.ts#L67-L72

2. 內存洩漏：OAuth 狀態未清理（由於 finally 塊中缺少清理而導致的錯誤）

https://github.com/owner/repo/blob/abc123.../src/auth.ts#L88-L95

3. 不一致的命名模式（src/conventions/CLAUDE.md 說"對函數使用 camelCase"）

https://github.com/owner/repo/blob/abc123.../src/utils.ts#L23-L28
```

**置信度評分：**
- **0**：不確定，誤報
- **25**：有點確定，可能是真的
- **50**：中等確定，真實但次要
- **75**：高度確定，真實且重要
- **100**：絕對確定，肯定是真的

**過濾的誤報：**
- PR 中未引入的預存問題
- 看起來像錯誤但實際上不是的代碼
- 迂腐的吹毛求疵
- 檢查工具會捕獲的問題
- 一般質量問題（除非在 CLAUDE.md 中）
- 帶有 lint 忽略註釋的問題

## 安裝

此插件包含在 Claude Code 存儲庫中。使用 Claude Code 時，該命令會自動可用。

## 最佳實踐

### 使用 `/code-review`
- 維護清晰的 CLAUDE.md 文件以更好地進行合規性檢查
- 信任 80+ 置信度閾值 - 誤報已被過濾
- 在所有非瑣碎的拉取請求上運行
- 將代理發現作為人工審查的起點
- 根據反覆出現的審查模式更新 CLAUDE.md

### 何時使用
- 所有具有有意義變更的拉取請求
- 涉及關鍵代碼路徑的 PR
- 來自多個貢獻者的 PR
- 指南合規性很重要的 PR

### 何時不使用
- 已關閉或草稿 PR（無論如何都會自動跳過）
- 瑣碎的自動化 PR（自動跳過）
- 需要立即合併的緊急修補程序
- 已審查的 PR（自動跳過）

## 工作流程集成

### 標準 PR 審查工作流程：
```bash
# 創建帶有變更的 PR
/code-review

# 查看自動反饋
# 進行任何必要的修復
# 準備好後合併
```

### 作為 CI/CD 的一部分：
```bash
# 在 PR 創建或更新時觸發
# 自動發布審查評論
# 如果審查已存在則跳過
```

## 要求

- 具有 GitHub 集成的 Git 存儲庫
- 已安裝並驗證的 GitHub CLI（`gh`）
- CLAUDE.md 文件（可選但建議用於指南檢查）

## 疑難排解

### 審查時間過長

**問題**：大型 PR 上的代理速度緩慢

**解決方案**：
- 對於大型變更來說是正常的 - 代理並行運行
- 4 個獨立代理確保徹底性
- 考慮將大型 PR 拆分為較小的

### 誤報太多

**問題**：審查標記的問題不是真實的

**解決方案**：
- 默認閾值為 80（已經過濾了大多數誤報）
- 使 CLAUDE.md 更具體地說明重要的內容
- 考慮標記的問題是否實際上有效

### 未發布審查評論

**問題**：`/code-review` 運行但沒有評論出現

**解決方案**：
檢查是否：
- PR 已關閉（跳過審查）
- PR 是草稿（跳過審查）
- PR 是瑣碎/自動化的（跳過審查）
- PR 已經有審查（跳過審查）
- 沒有問題評分 ≥80（不需要評論）

### 鏈接格式損壞

**問題**：代碼鏈接在 GitHub 中無法正確渲染

**解決方案**：
鏈接必須遵循以下確切格式：
```
https://github.com/owner/repo/blob/[完整-sha]/path/file.ext#L[開始]-L[結束]
```
- 必須使用完整的 SHA（不是縮寫）
- 必須使用 `#L` 表示法
- 必須包含至少 1 行上下文的行範圍

### GitHub CLI 不工作

**問題**：`gh` 命令失敗

**解決方案**：
- 安裝 GitHub CLI：`brew install gh`（macOS）或參見 [GitHub CLI 安裝](https://cli.github.com/)
- 驗證：`gh auth login`
- 驗證存儲庫具有 GitHub 遠程

## 提示

- **編寫具體的 CLAUDE.md 文件**：清晰的指南 = 更好的審查
- **在 PR 中包含上下文**：幫助代理理解意圖
- **使用置信度分數**：≥80 的問題通常是正確的
- **迭代指南**：根據模式更新 CLAUDE.md
- **自動審查**：設置為 PR 工作流程的一部分
- **信任過濾**：閾值防止噪音

## 配置

### 調整置信度閾值

默認閾值為 80。要調整，請在 `commands/code-review.md` 修改命令文件：
```markdown
過濾掉評分低於 80 的任何問題。
```

將 `80` 更改為您的首選閾值（0-100）。

### 自定義審查重點

編輯 `commands/code-review.md` 以添加或修改代理任務：
- 添加注重安全性的代理
- 添加性能分析代理
- 添加可訪問性檢查代理
- 添加文檔質量檢查

## 技術細節

### 代理架構
- **2x CLAUDE.md 合規性代理**：指南檢查的冗餘
- **1x 錯誤檢測器**：僅專注於變更中的明顯錯誤
- **1x 歷史分析器**：來自 git blame 和歷史記錄的上下文
- **Nx 置信度評分器**：每個問題一個，用於獨立評分

### 評分系統
- 每個問題獨立評分 0-100
- 評分考慮證據強度和驗證
- 閾值（默認 80）過濾低置信度問題
- 對於 CLAUDE.md 問題：驗證指南是否明確提到它

### GitHub 集成
使用 `gh` CLI 進行：
- 查看 PR 詳細信息和差異
- 獲取存儲庫數據
- 讀取 git blame 和歷史記錄
- 發布審查評論

## 作者

Boris Cherny (boris@anthropic.com)

## 版本

1.0.0
